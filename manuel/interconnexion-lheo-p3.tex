\documentclass[a4paper]{report}
\usepackage[utf8]{inputenc}
\usepackage{alltt}
\usepackage{fullpage}
\usepackage[francais]{babel}
\usepackage{palatino}
\usepackage{longtable}
\usepackage{color}
\usepackage{fancyvrb}
\usepackage{makeidx}
\usepackage{hyperref}
\usepackage{graphicx}
\def\rappel#1{\S\ref{#1}, p.~\pageref{#1}}
\setlength{\parskip}{1ex}
\setlength{\parindent}{0pt}


\begin{document}
\thispagestyle{empty}

\begin{center}
\includegraphics[width=.3\textwidth]{marianne.pdf}\\\hrule
{\small\textsc{Délégation générale à l’emploi et à la formation professionnelle (DGEFP)}}
\end{center}

\vfill

\begin{center}
\includegraphics[width=.4\textwidth]{logo_lheo.pdf} \\[.5cm]
{\huge Spécifications fonctionnelles de l'interconnexion entre les CARIF-OREF et Parcours 3}
\end{center}

\vfill

$$\includegraphics[width=.3\textwidth]{logo_armines.pdf}$$

\begin{center}
  \begin{tabular}{|l|l|}\hline
    \textsf{État du document} & travail \\\hline
    \textsf{Date du document} & \today \\\hline
    \textsf{Version} & 0.1 \\\hline
    \textsf{Auteur (Armines)} &  Georges-André Silber\\\hline
    \textsf{Approbateur (DGEFP)} &  Laurent Durain\\\hline
    \textsf{Révision} & $Rev$ \\\hline
  \end{tabular}
\end{center}

\newpage
\tableofcontents

\chapter{Introduction}

L'objectif de ce document est de décrire en détail le fonctionnement
de l'interconnexion entre les CARIF-OREF et Parcours 3, en utilisant le
langage LHÉO pour décrire les offres de formation.  Ce fonctionnement
simplifié est décrit dans le schéma ci-dessous.

$$\includegraphics[width=\textwidth]{lheo-leger-p3-fonctionnel}$$

\chapter{Interrogation de l'offre de formation des CARIF-OREF depuis Parcours 3}

Ce flux permet à Parcours 3 d'obtenir une liste de formation publiées
par un CARIF-OREF, selon des critères définis ci-dessous. Ces critères
de recherche sont ceux de la version courante de Parcours 3.

\section{Les données en entrée (critères de sélection)}

Afin d'obtenir une liste d'information auprès d'un CARIF-OREF, les
critères de recherche présentés ci-dessous peuvent-être utilisés dans
l'application Parcours 3.

 \begin{tabular}{|l|c|p{.65\textwidth}|} \hline
  \textbf{Intitulé} & \textbf{Type} & \textbf{Commentaire} \\\hline\hline
  
  Intitulé de l'action & texte & Permet de spécifier une chaîne de caractères devant être contenue dans l'intitulé de l'action de formation.\\
  \hline

  Diplômante & code & Indique si la formation recherchée doit être diplômante ou non (ou si c'est indifférent).\\
  \hline

  Niveau d'entrée & code & Permet de rechercher une formation dont le niveau est supérieur, inférieur ou égal à un niveau (niveau I, niveau II, niveau III, etc...).\\
  \hline

  Date de début & date & Permet d'indiquer une date de formation minimale de début de la formation.\\
  \hline

  Public visé & code & Permet de spécifier un public visé: \textit{en emploi}, \textit{sans emploi} ou \textit{tout public}.\\
  \hline

  Formacode & code & Permet de choisir un Formacode dans une liste.\\
  \hline

  ROME & code & Permet de choisir un ROME dans une liste.\\
  \hline

  Nom organisme & texte & Permet de spécifier une chaîne de caractères devant être contenue dans le nom de l'organisme.\\
  \hline
  
  Lieu de formation & multiples & Permet de spécifier des critères pour le lieu de formation (région, département, canton, commune).\\
  \hline
\end{tabular}

L'écran d'interrogation actuel dans l'application Parcours 3 est présenté ci-dessous.

$$\includegraphics[width=\textwidth]{grille-interrogation-parcours}$$

\section{Les données en sortie}

Le service de recherche renvoie une liste d'offres de formation
résumées, où pour chaque offre les informations ci-dessous sont
présentées:

\begin{tabular}{|l|c|p{.65\textwidth}|} \hline
  \textbf{Intitulé} & \textbf{Type} & \textbf{Commentaire} \\\hline\hline
  
  Organisme & texte & Nom de l'organisme responsable de la formation.\\
  \hline

  Libellé & texte & Intitulé de l'action de formation.\\
  \hline

  Ville / Code postal & texte et code & Ville et code postal du lieu de formation.\\
  \hline

  Date début session & dates & Liste de dates de début de session de formation.\\
  \hline

  Contact & texte et numéro & Nom de la personne pouvant donner des renseignements sur la formation et numéro de téléphone (si disponible).\\
  \hline
\end{tabular}

L'écran de présentation actuel de la liste de résultats dans
l'application Parcours 3 est présenté ci-dessous.

$$\includegraphics[width=\textwidth]{liste-formations-parcours}$$

\chapter{Le chargement du détail d'une offre de formation}

La liste des offres de formation résumée permet dans l'application
Parcours 3 de cliquer sur un élément de la liste et de récupérer
depuis le site du CARIF-OREF correspondant le détail de l'offre de
formation.

\section{Les données en entrée}

La donnée en entrée est la référence d'une offre de formation (obtenue
par le système lorsque l'utilisateur clique sur une offre de
formation). Concrètement, cette référence est l'URL (l'identificateur
d'une ressource web) de cette offre sur le site web du CARIF.

\section{Les données en sortie}

Le détail de l'offre contient les éléments disponibles dans le format
XML LHÉO \cite{WEB-LHEO}.

\input{cercles.tex}

L'écran d'affichage du détail d'une offre dans Parcours 3 ressemble à
ce qui est présenté ci-dessous.

$$\includegraphics[width=\textwidth]{detail-offre-parcours}$$

\appendix
\chapter{Annexe technique}

Cette annexe s'adresse aux responsables informatiques des CARIF-OREF.
L'interconnexion fait intervenir trois acteurs: le site web du
CARIF-OREF, le serveur d'index maintenu par Armines et l'applicatif
Parcours 3. Le site web du CARIF-OREF fournit les données, le serveur
d'index permet à l'applicatif Parcours 3 d'effectuer une recherche
dans ces données et l'applicatif Parcours 3 permet aux utilisateurs
des missions locales d'effectuer une recherche dans les données et
d'afficher le détail d'une offre de formation récupérée sur le site du
CARIF-OREF.Ce fonctionnement détaillé est décrit dans la figure
ci-dessous.

%\begin{figure}[Htb]
$$\includegraphics[width=\textwidth]{fonctionnement_recherche_parcours3}$$
%  \caption{\label{fig:recherche}Schéma d'interconnexion entre les
%    différentes entités (Un CARIF-OREF, serveur d'index Armines,
%    Parcours 3)}
%\end{figure}

\paragraph{Serveur du CARIF-OREF.} Le CARIF-OREF effectue toutes les
nuits (où à un intervalle à déterminer) à une heure donnée, un export
des données au format LHÉO: un index au format XML LHÉO-Léger et
chaque offre au format XML LHÉO \cite{WEB-LHEO,MANUEL-LHEO}. Ces
fichiers sont disponibles sur Internet sur le serveur web du
CARIF-OREF par le biais d'URL (une URL par fichier). Seule l'URL du
fichier d'index doit être fixe et connue du serveur d'index.

\paragraph{Serveur d'index.} Le serveur d'index récupère toutes les
nuits à une heure donnée le fichier d'index au format XML LHÉO-Léger
dont il connaît l'URL.  Il effectue une validation des données par
rapport à la DTD \cite{DTD-LHEO} et au Schéma XML W3C \cite{XSD-LHEO}
de LHÉO. Le fichier d'index est intégré au \emph{service web} destiné
à Parcours 3. Un rapport d'intégration et de validation est envoyé par
mail au CARIF-OREF.  Le service web est accessible uniquement à
Parcours 3.  L'opération de récupération peut-être effectuée sur
plusieurs CARIF-OREF.

\paragraph{Parcours 3.} Les utilisateurs des missions locales peuvent
utiliser un formulaire de recherche sur Parcours pour aller interroger
le web service du serveur d'index et ainsi récupérer une liste
d'offres de formation. Il est possible d'obtenir le détail d'une offre
en allant récupérer le fichier au format XML LHÉO sur le site du
CARIF-OREF correspondant.

Dans ce qui suit, nous allons décrire en détail cette interconnexion
entre ces différents acteurs et les travaux nécessaires du côté d'un
CARIF-OREF afin que son offre de formation soit disponible pour
Parcours 3.


\section{Export des données au format XML LHÉO 1.3.0}

Les données décrivant l'offre de formation doivent être exportées de
la base au format LHÉO (au moins le cercle 1 des données, voir
\cite{WEB-LHEO,MANUEL-LHEO}.  L'export doit se faire en respectant la
DTD et le Schéma XML de LHÉO \cite{DTD-LHEO,XSD-LHEO}. Le jeu de
caractères utilisé doit être UTF-8.

\subsection{Spécification de l'espace de noms}

L'espace de nom \texttt{http://wwww.lheo.org/1.3.0} doit être
positionné dans les éléments \texttt{lheo} et \texttt{lheo-leger} afin
d'indiquer la version de LHÉO utilisée pour l'export.

Concrètement, le fichier LHÉO-Léger doit ressembler à ceci:

\begin{alltt}
<lheo-leger \textbf{xmlns="http://www.lheo.org/1.3.0"}>
  ...
</lheo-leger>
\end{alltt}

et le fichier LHÉO à ceci:

\begin{alltt}
<lheo \textbf{xmlns="http://www.lheo.org/1.3.0"}>
  ...
</lheo>
\end{alltt}

\subsection{Marquage des fichiers XML LHÉO}

Afin d'identifier la provenance d'un fichier XML LHÉO-Léger, celui-ci
doit être marqué par des informations contenues dans une balise
d'extension \texttt{<extras info="FLUX-CARIF">} qui doit avoir la
structure suivante (tous les éléments sont obligatoires):

\begin{alltt}
  \textbf{<extras info="FLUX-CARIF">}
    \textbf{<extra info="numero-CARIF">}21\textbf{</extra>}
    \textbf{<extra info="region">}52\textbf{</extra>}
    \textbf{<extra info="email-CARIF">}informatique@cariforef-pdl.org\textbf{</extra>}
    \textbf{<extra info="date-export">}20080613\textbf{</extra>}
    \textbf{<extra info="heure-export">}013402\textbf{</extra>}
  \textbf{</extras>}
\end{alltt}

Les différents éléments \texttt{<extra>} doivent avoir le contenu
suivant:

\begin{center}
\begin{tabular}{|p{.2\textwidth}|p{.70\textwidth}|}\hline
  \textbf{attribut \texttt{info}} & Type du contenu \\\hline\hline
  \texttt{numero-CARIF} & Numéro du CARIF-OREF qui a généré le fichier XML.\\\hline
  \texttt{region} & Code de la région dont fait partie le CARIF-OREF (voir la table \texttt{dict-regions-france} de LHÉO \cite{WEB-LHEO,MANUEL-LHEO}).\\\hline
  \texttt{email-CARIF} & Adresse email valide permettant d'envoyer le rapport de validation et d'intégration du fichier dans le service d'index.\\\hline
  \texttt{date-export} & Date de début de l'export (voir le format de l'élément \texttt{date} de LHÉO qui est identique \cite{WEB-LHEO,MANUEL-LHEO}). Sous Unix/Linux, la commande shell \texttt{date '+\%Y\%m\%d'} permet d'obtenir une date à ce format.\\\hline
  \texttt{heure-export} & Heure de début de l'export. Sous Unix/Linux, la commande shell \texttt{date '+\%H\%M\%S'} permet d'obtenir une date à ce format.\\
  \hline
\end{tabular}
\end{center}

Il est à noter qu'il faut respecter scrupuleusement la casse des
attributs \texttt{info}.

Cet élément \texttt{<extras info="FLUX-CARIF">} doit être positionné
dans l'élément \texttt{<lheo-leger>}, à l'endroit prévu dans la DTD
(voir le manuel de référence \cite{MANUEL-LHEO}). Le fichier XML
LHEO-Léger doit donc ressembler à ceci:

\begin{alltt}
<lheo-leger xmlns="http://www.lheo.org/1.3.0">
  <resumes-offres>
    <resume-offre file="http://cariforef-pdl.org/lheo/offre1.xml">
      ...
    </resume-offre>
    <resume-offre file="http://cariforef-pdl.org/lheo/offre2.xml">
      ...
    </resume-offre>
    ...
    <resume-offre file="http://cariforef-pdl.org/lheo/offre2435.xml">
      ...
    </resume-offre>    
  </resumes-offres>
  \textbf{<extras info="FLUX-CARIF">}
    \textbf{<extra info="numero-CARIF">}21\textbf{</extra>}
    \textbf{<extra info="region">}52\textbf{</extra>}
    \textbf{<extra info="email-CARIF">}informatique@cariforef-pdl.org\textbf{</extra>}
    \textbf{<extra info="date-export">}20080613\textbf{</extra>}
    \textbf{<extra info="heure-export">}013402\textbf{</extra>}
  \textbf{</extras>}
</lheo-leger>
\end{alltt}

Il faut également ajouter l'élément \texttt{<extras info="FLUX-CARIF">} suivant
à la fin de chaque fichier LHÉO exporté:

\begin{alltt}
<lheo xmlns="http://www.lheo.org/1.3.0">
  <offres>
    <offre-formation>
      ...
    </offre-formation>    
  </offres>
  \textbf{<extras info="FLUX-CARIF">}
    \textbf{<extra info="numero-CARIF">}21\textbf{</extra>}
    \textbf{<extra info="region">}52\textbf{</extra>}
    \textbf{<extra info="email-CARIF">}informatique@cariforef-pdl.org\textbf{</extra>}
    \textbf{<extra info="date-export">}20080613\textbf{</extra>}
    \textbf{<extra info="heure-export">}013402\textbf{</extra>}
  \textbf{</extras>}
</lheo>
\end{alltt}

Les éléments \texttt{date-export} et \texttt{heure-export} doivent être
identiques pour tous les fichiers (incluant le fichier LHÉO-Léger),
afin de tester la cohérence de l'export lors de l'importation sur le
serveur d'index.

\subsection{Informations supplémentaires optionnelles}

Il est possible pour un CARIF-OREF d'ajouter des informations
complémentaires dans les fichiers LHÉO et LHÉO-Léger. Par exemple, si
des informations de géolocalisation (latitude, longitude) de l'adresse
de formation sont disponibles dans la base du CARIF-OREF ou si
celles-ci peuvent être calculées par le CARIF-OREF, il est possible
d'ajouter ces données dans un élément \texttt{<extras>} de l'élément
\texttt{<resume-offre>} de la façon suivante:

\begin{alltt}
<lheo-leger xmlns="http://www.lheo.org/1.3.0">
  <resumes-offres>
    <resume-offre file="http://cariforef-pdl.org/lheo/offre1.xml">
      <domaine-formation>...</domaine-formation>
      <intitule-action>...</intitule-action>
      ...
      \textbf{<extras info="geolocalisation">}
         \textbf{<extra info="latitude">45.804363</extra>}
         \textbf{<extra info="longitude">4.887452</extra>}
      \textbf{</extras>}
    </resume-offre>
    <resume-offre file="http://cariforef-pdl.org/lheo/offre2.xml">
      <domaine-formation>...</domaine-formation>
      <intitule-action>...</intitule-action>
      ...
      \textbf{<extras info="geolocalisation">}
         \textbf{<extra info="latitude">45.903454</extra>}
         \textbf{<extra info="longitude">4.90</extra>}
      \textbf{</extras>}
    </resume-offre>
    ...
  </resumes-offres>
  ...
</lheo-leger>
\end{alltt}

\noindent Il est également possible d'ajouter ces informations au
niveau d'une offre LHÉO, dans l'élément \texttt{<coordonnees>} contenu
dans l'élément \texttt{<lieu-de-formation>}:

\begin{alltt}
...
  <lieu-de-formation>
    <coordonnees>
      ...
      \textbf{<extras info="geolocalisation">}
         \textbf{<extra info="latitude">45.804363</extra>}
         \textbf{<extra info="longitude">4.887452</extra>}
      \textbf{</extras>}
    </coordonnees>
  </lieu-de-formation>
...
\end{alltt}

\section{Interactions avec le serveur d'index}

\subsection{URL du fichier LHÉO-Léger}

Afin que l'intégration des données de l'index soit possible au niveau
du serveur d'index, celui-ci doit connaître l'URL du fichier d'index
sur le site web du CARIF-OREF. La récupération de ce fichier sera
faîte par l'intermédiaire du protocole HTTP (de préférence) ou
FTP. Cette récupération peut-être restreinte par le CARIF-OREF à
l'adresse IP du serveur d'index (qui peut être transmise par Armines
sur demande) ou le CARIF-OREF peut transmettre un identifiant et un
mot de passe qui permet de se connecter au site.

\subsection{Date du fichier d'index}

Il est nécessaire de faire en sorte que le fichier déposé sur le
serveur du CARIF-OREF possède une date correcte (composante
\texttt{Last-Modified:} sur serveur HTTP ou la date du fichier pour un
serveur FTP). Cette date sera utilisée par le serveur d'index pour
déterminer si une récupération doit avoir lieu.

\subsection{Fichiers XML LHÉO des offres détaillées}

Les fichiers XML LHÉO des offres détaillées doivent être disponibles
en même temps que le fichier d'index. Les URL présentes dans les
attributs \texttt{file} des éléments \texttt{<resume-offre>} du
fichier d'index doivent être valides. Les offres doivent être
accessibles par l'intermédiaire du protocole HTTP, sans
identification. Le CARIF-OREF pourra, si il le souhaite, filtrer
l'accès aux offres détaillées par l'adresse IP du serveur d'index et
du serveur Parcours 3.

\subsection{Heure de récupération du fichier}

Toutes les nuits, les données sont récupérées sur les différents
CARIF-OREF à 2h du matin. Si le fichier d'index est nouveau celui-ci
est récupéré et stocké sur le serveur d'index.

\subsection{Validation et intégration du fichier d'index et rapport d'intégration}

Une fois tous les fichiers récupérés, le serveur d'index valide chaque
fichier et envoie un rapport d'intégration à chaque CARIF-OREF.

\paragraph{Fichiers d'index.} Chaque fichier d'index récupéré est
validé par rapport au Schéma XML W3C de LHÉO \cite{XSD-LHEO} et par
rapport à la conformité des balises \texttt{<extras
  info="FLUX-CARIF">} décrites ci-dessus. Si le fichier est incorrect,
l'intégration s'arrête et le CARIF-OREF reçoit par mail un rapport
d'intégration négatif indiquant précisément l'erreur obtenue (sur le
modèle de la sortie de l'utilitaire \texttt{xmllint}, voir
\url{http://www.xmlsoft.org}). Les données du CARIF-OREF ne seront pas
accessible pour l'application Parcours 3.

\paragraph{Fichiers détaillés.} Chaque fichier détaillé référencé par
un fichier d'index sera récupéré sur le serveur du CARIF-OREF et
validé par rapport au Schéma XML W3C de LHÉO \cite{XSD-LHEO} et par
rapport à la conformité des balises \texttt{<extras
  info="FLUX-CARIF">} décrites ci-dessus. Si un fichier est incorrect,
ce fichier ne sera pas mis dans l'index disponible pour Parcours 3 et
les erreurs seront ajoutées au rapport d'intégration transmis au
CARIF-OREF (sur le modèle de la sortie de l'utilitaire
\texttt{xmllint}, voir \url{http://www.xmlsoft.org}). Si il n'y a
aucune offre valide dans un index donné, cet index ne sera par intégré
au serveur d'index. Seules les offres valides seront intégrées à
l'index global du serveur d'index. Il est à noter que les offres
détaillées récupérées pour cette validation ne sont pas conservées sur
le serveur d'index.

Cette approche permet d'une part de ne pas rejeter complètement les
offres d'un CARIF-OREF si une seule est invalide et de garantir que
Parcours 3 ait accès à une base d'offres valides.

\section{Utilisation des offres détaillées par Parcours 3}

Au gré des recherches effectuées par les conseillers des missions
locales, les serveurs web des CARIF-OREF seront sollicités tous les
jours ouvrables, pendant les heures d'ouvertures de missions locales,
pour la récupération des offres détaillées. Ainsi, il convient donc
d'assurer que le détail de ces offres sera disponible pour Parcours 3
pendant ces plages de temps.

\section{Statistiques}

Tous les soirs à 22h, un rapport d'utilisation des données (requêtes
effectuées) d'index sera envoyé par le serveur d'index par mail à
chaque CARIF-OREF.

\begin{thebibliography}{1}
\bibitem{WEB-LHEO} {Site web de référence de LHÉO}.
  \newblock \url{http://www.lheo.org}.

\bibitem{MANUEL-LHEO} {Manuel d'utilisation de LHÉO 1.3.0}.
  \newblock \url{http://www.lheo.org/1.3.0/lheo.pdf}.

\bibitem{DTD-LHEO} {DTD de LHÉO 1.3.0}.
  \newblock \url{http://www.lheo.org/1.3.0/lheo.dtd}.

\bibitem{XSD-LHEO} {Schéma XML W3C de LHÉO 1.3.0}.
  \newblock \url{http://www.lheo.org/1.3.0/lheo.xsd}.

\bibitem{TABLES-LHEO} {Tables de LHÉO 1.3.0}.
  \newblock \url{http://www.lheo.org/1.3.0/lheo-tables.xml}.
\end{thebibliography}
\end{document}

TODO: xmlns='' à mettre
TODO: interaction avec le meta-moteur ? Remise a disposition des flux valides ?
TODO: lheo-plus
TODO: restriction par adresse IP.
TODO: geolocalisation et MetamoteurTODO: URL fichier d'index.
TODO: URL des fichiers.
TODO: heures d'ouverture.
